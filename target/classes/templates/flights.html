<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
	<meta charset="utf-8"/>
	<title>Search Flights</title>

	<link rel="stylesheet" th:href="@{/css/style.css}">
	<link rel="stylesheet" th:href="@{/css/card.css}">
	<link rel="stylesheet" th:href="@{/css/search.css}">
</head>
<body>
<header>
	<div th:replace="fragments/navbar :: navbar"></div>
</header>

<main>
	<h1 class="page-title">Search Flights</h1>

	<div th:replace="fragments/searchForm :: searchForm"></div>

	<br/>
	<hr/>

	<div id="searchResults">
		<table style="border:1px solid black; width:100%; border-collapse:collapse;">
			<thead>
			<tr>
				<th>Flight No</th>
				<th>Origin</th>
				<th>Destination</th>
				<th>Departure</th>
				<th>Price (Economy)</th>
				<th>Price (Business)</th>
				<th>Action</th>
			</tr>
			</thead>
			<tbody>
			<tr th:each="flight : ${flights}">
				<td th:text="${flight.flightNumber}"></td>
				<td th:text="${flight.origin}"></td>
				<td th:text="${flight.destination}"></td>
				<td th:text="${departureMap[flight.id]}"></td>
				<td th:text="${flight.priceEconomy}"></td>
				<td th:text="${flight.priceBusiness}"></td>
				<td>
					<a th:if="${session.userId != null}"
					   th:href="@{/user/book(flightId=${flight.id})}">Book</a>
					<a th:unless="${session.userId != null}"
					   th:href="@{/login}">Book</a>
				</td>
			</tr>
			</tbody>
		</table>
	</div>
</main>

<footer>
	<div th:replace="fragments/footer :: footer"></div>
</footer>

<script>
	document.addEventListener('DOMContentLoaded', function () {
		const form = document.getElementById('flightSearchForm');
		if (!form) return;

		form.addEventListener('submit', function (e) {
			e.preventDefault();
			const params = new URLSearchParams(new FormData(form));
			params.set('ajax', 'true');

			const action = form.getAttribute('action') || '/flights';
			const url = action + '?' + params.toString();

			fetch(url, {
				method: 'GET',
				headers: {
					'X-Requested-With': 'XMLHttpRequest',
					'Accept': 'text/html'
				}
			})
					.then(response => {
						if (!response.ok) throw new Error('Network response was not ok');
						return response.text();
					})
					.then(html => {
						document.getElementById('searchResults').innerHTML = html;
					})
					.catch(err => {
						console.error('Search request failed', err);
					});
		});
	});
</script>
</body>
</html>