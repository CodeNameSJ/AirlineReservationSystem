<!DOCTYPE html>
<html lang="en"
      layout:decorate="~{layout}"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org">
<head>
	<div layout:fragment="head">
		<title>Manage Bookings</title>
	</div>
</head>
<body>
<div layout:fragment="content">
	<h1>Manage Bookings</h1>
	<div class="action-bar">
		<a class="btn secondary" th:href="@{/admin/bookings/new}">New Booking</a>
	</div>

	<table class="booking-table">
		<thead>
		<tr>
			<th>ID</th>
			<th>User</th>
			<th>Flight</th>
			<th>Seat Class</th>
			<th>Departure</th>
			<th>Seats</th>
			<th>Date</th>
			<th>Status</th>
			<th>Action</th>
		</tr>
		</thead>
		<tbody>
		<tr th:each="b : ${bookings}">
			<td th:text="${b.id}">1</td>
			<td th:text="${b.user.username}">user</td>
			<td th:text="${b.flight.flightNumber}">FL123</td>
			<td th:text="${b.seatClass}">ECONOMY</td>
			<td th:text="${b.flight.departureDisplay}">now</td>
			<td th:text="${b.seats}">2</td>
			<td th:text="${b.bookingTimeDisplay}">2025-08-17</td>
			<td th:text="${b.status}">BOOKED</td>
			<td>
				<form method="get" style="display:inline;" th:action="@{/admin/bookings/edit/{id}(id=${b.id})}">
					<button class="btn-edit crud-button" type="submit">Edit</button>
				</form>

				<button class="btn-cancel crud-button" th:if="${b.status != null and #strings.equalsIgnoreCase(b.status.toString(), 'BOOKED')}"
				        th:onclick="'toggleWarning(' + ${b.id} + ', \'cancel\', true)'"
				        type="button">
					Cancel
				</button>

				<button class="btn-delete crud-button" th:if="${b.status != null and (#strings.equalsIgnoreCase(b.status.toString(), 'BOOKED') or #strings.equalsIgnoreCase(b.status.toString(), 'CANCELLED'))}"
				        th:onclick="'toggleWarning(' + ${b.id} + ', \'delete\', true)'"
				        type="button">
					Delete
				</button>
			</td>
		</tr>

		<tr class="warning-row" style="display:none;" th:each="b : ${bookings}" th:id="'warning-cancel-' + ${b.id}"
		    th:if="${b.status != null and #strings.equalsIgnoreCase(b.status.toString(), 'BOOKED')}">
			<td colspan="9">
				<strong>&#9888; This booking is active. Canceling will restore seats. Proceed?</strong><br/><br/>
				<form style="display:inline;" th:action="@{/admin/bookings/cancel}" th:method="post">
					<input name="id" th:value="${b.id}" type="hidden"/>
					<input name="confirm" type="hidden" value="true"/>
					<button style="background:#f0ad4e;color:white;" type="submit">Yes, Cancel</button>
				</form>
				<button th:onclick="'toggleWarning(' + ${b.id} + ', \'cancel\', false)'" type="button">No, Keep</button>
			</td>
		</tr>

		<tr class="warning-row" style="display:none;" th:each="b : ${bookings}" th:id="'warning-delete-' + ${b.id}">
			<td colspan="9">
				<strong>&#9888; This will permanently delete the booking. Proceed?</strong><br/><br/>
				<form style="display:inline;" th:action="@{/admin/bookings/delete}" th:method="post">
					<input name="id" th:value="${b.id}" type="hidden"/>
					<input name="confirm" type="hidden" value="true"/>
					<button style="background:#d9534f;color:white;" type="submit">Yes, Delete</button>
				</form>
				<button th:onclick="'toggleWarning(' + ${b.id} + ', \'delete\', false)'" type="button">No, Keep</button>
			</td>
		</tr>
		</tbody>
	</table>
</div>

<div layout:fragment="scripts">
	<script defer th:src="@{/js/confirmation.js}"></script>
</div>
</body>
</html>