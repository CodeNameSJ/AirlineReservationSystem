<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      lang="en"
      layout:decorate="~{layout}">

<head>
	<div layout:fragment="head">
		<title>My Bookings</title>
	</div>
</head>

<div layout:fragment="content">
	<h2>Welcome, <span th:text="${session.username}">Username</span></h2>

	<h3>Your Bookings</h3>

	<table class="booking-table" aria-describedby="booking-info">
		<thead>
		<tr>
			<th>ID</th>
			<th>Flight</th>
			<th>Class</th>
			<th>Seats</th>
			<th>Departure</th>
			<th>Status</th>
			<th>Action</th>
		</tr>
		</thead>
		<tbody>
		<tr th:each="booking : ${bookings}">
			<td th:text="${booking.id}">1</td>
			<td th:text="${booking.flight != null ? booking.flight.flightNumber : '-'}">FL123</td>
			<td th:text="${booking.seatClass}">Economy</td>
			<td th:text="${booking.flight.departureDisplay}"></td>
			<td th:text="${booking.seats}">2</td>
			<td th:text="${booking.status}">BOOKED</td>
			<td>
				<!-- null-safe check for BOOKED -->
				<button type="button" class="btn-cancel crud-button"
				        th:if="${booking.status != null and #strings.equalsIgnoreCase(booking.status.toString(), 'BOOKED')}"
				        th:onclick="'toggleWarning(' + ${booking.id} + ', \'cancel\', true)'">
					Cancel
				</button>

				<span th:unless="${booking.status != null and #strings.equalsIgnoreCase(booking.status.toString(), 'BOOKED')}">â€”</span>
			</td>
		</tr>

		<tr th:each="booking : ${bookings}"
		    th:id="'warning-cancel-' + ${booking.id}"
		    class="warning-row"
		    style="display:none;"
		    th:if="${booking.status != null and #strings.equalsIgnoreCase(booking.status.toString(), 'BOOKED')}">
			<td colspan="7">
				<strong>&#9888; Cancel booking?</strong>
				<p>This cannot be undone.</p>

				<form th:method="post" th:action="@{/user/bookings/cancel}" style="display:inline;">
					<input type="hidden" name="id" th:value="${booking.id}"/>
					<input type="hidden" name="confirm" value="true"/>
					<button type="submit"
					        style="background-color:#f0ad4e; color:#fff; border:none; padding:8px 12px; border-radius:6px;">
						Yes, Cancel
					</button>
				</form>

				<button type="button"
				        th:onclick="'toggleWarning(' + ${booking.id} + ', \'cancel\', false)'"
				        style="margin-left:8px; padding:8px 12px; border-radius:6px;">
					No, Keep
				</button>
			</td>
		</tr>

		<tr th:if="${bookings == null or #lists.isEmpty(bookings)}">
			<td colspan="6" style="text-align:center; padding:12px;">You have no bookings.</td>
		</tr>
		</tbody>
	</table>
</div>

<div layout:fragment="scripts">
	<script th:src="@{/js/confirmation.js}" defer></script>
</div>

</html>